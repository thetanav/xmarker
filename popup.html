<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X Highlighter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 280px;
      min-height: 120px;
      max-height: 400px;
      overflow-y: auto;
      background: #15202b;
      color: #f7f9f9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
    }

.header {
  padding: 12px 16px;
  border-bottom: 1px solid #38444d;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header h1 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.header h1 svg {
  width: 20px;
  height: 20px;
}

.stats {
  font-size: 12px;
  color: #8b98a5;
  margin-left: auto;
}

.content {
  padding: 12px;
}

.highlight-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.highlight-item {
  background: #1d2a36;
  border-radius: 6px;
  padding: 10px;
  cursor: pointer;
  transition: all 0.15s ease;
  border: 1px solid transparent;
}

.highlight-item:hover {
  background: #273340;
  border-color: #1d9bf0;
}

.highlight-text {
  font-size: 12px;
  line-height: 1.4;
  margin-bottom: 6px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.highlight-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 10px;
  color: #8b98a5;
}

.highlight-color {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  border: 1px solid rgba(255,255,255,0.2);
}

.empty-state {
  text-align: center;
  padding: 24px 12px;
  color: #8b98a5;
}

.empty-state svg {
  width: 32px;
  height: 32px;
  margin-bottom: 8px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 12px;
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #38444d;
}

.btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  border: none;
}

.btn svg {
  width: 14px;
  height: 14px;
}

.btn-primary {
  background: #1d9bf0;
  color: white;
}

.btn-primary:hover {
  background: #1a8cd8;
}

.btn-secondary {
  background: #273340;
  color: #f7f9f9;
}

.btn-secondary:hover {
  background: #38444d;
}

.btn-danger {
  background: rgba(244, 33, 46, 0.1);
  color: #f4212e;
}

.btn-danger:hover {
  background: rgba(244, 33, 46, 0.2);
}

.toast {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #273340;
  color: #f7f9f9;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  opacity: 0;
  transition: all 0.2s ease;
  z-index: 1000;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}
</style>
</head>
<body>
  <div class="header">
    <h1>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 11L12 14L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      Highlights
    </h1>
    <span class="stats" id="stats">0</span>
  </div>

  <div class="content">
    <div class="highlight-list" id="highlight-list"></div>

    <div class="actions">
      <button class="btn btn-primary" id="view-all-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
        </svg>
        View All
      </button>
      <button class="btn btn-secondary" id="export-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export
      </button>
      <button class="btn btn-danger" id="clear-all-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Clear All
      </button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'x_highlighter_data';

    document.addEventListener('DOMContentLoaded', () => {
      loadHighlights();
      setupActions();
    });

    function setupActions() {
      document.getElementById('view-all-btn').addEventListener('click', () => {
        chrome.tabs.create({ url: chrome.runtime.getURL('highlights.html') });
      });

      document.getElementById('export-btn').addEventListener('click', exportHighlights);
      document.getElementById('clear-all-btn').addEventListener('click', clearAllHighlights);
    }

    function loadHighlights() {
      chrome.storage.local.get([STORAGE_KEY], (result) => {
        const highlights = result[STORAGE_KEY] || [];
        const currentUrl = window.location.href;
        const pageHighlights = highlights.filter(h => h.url === currentUrl);

        document.getElementById('stats').textContent = highlights.length;
        renderHighlights(pageHighlights);
      });
    }

    function renderHighlights(highlights) {
      const list = document.getElementById('highlight-list');

      if (highlights.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11L12 14L22 4"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <p>No highlights on this page</p>
          </div>
        `;
        return;
      }

      list.innerHTML = highlights.map(h => `
        <div class="highlight-item" data-id="${h.id}">
          <div class="highlight-text">${escapeHtml(h.text || '')}</div>
          <div class="highlight-meta">
            <span class="highlight-color" style="background: ${h.color || '#87CEEB80'}"></span>
            <span>${formatDate(h.timestamp)}</span>
          </div>
        </div>
      `).join('');

      list.querySelectorAll('.highlight-item').forEach(item => {
        item.addEventListener('click', () => {
          const h = highlights.find(hl => hl.id === item.dataset.id);
          if (h && h.url) chrome.tabs.create({ url: h.url });
        });
      });
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function exportHighlights() {
      chrome.storage.local.get([STORAGE_KEY], (result) => {
        const data = JSON.stringify(result[STORAGE_KEY] || [], null, 2);
        navigator.clipboard.writeText(data).then(() => showToast('Copied to clipboard!'));
      });
    }

    function clearAllHighlights() {
      if (confirm('Delete all highlights?')) {
        chrome.storage.local.set({ [STORAGE_KEY]: [] }, () => {
          loadHighlights();
          showToast('All highlights cleared');
          chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
            if (tabs[0] && (tabs[0].url.includes('x.com') || tabs[0].url.includes('twitter.com'))) {
              chrome.tabs.sendMessage(tabs[0].id, { action: 'reloadHighlights' });
            }
          });
        });
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  </script>
</body>
</html>

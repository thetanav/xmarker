<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X Highlighter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 280px;
      min-height: 120px;
      max-height: 400px;
      overflow-y: auto;
      background: #15202b;
      color: #f7f9f9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
    }

.header {
  padding: 12px 16px;
  border-bottom: 1px solid #38444d;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header h1 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.header h1 svg {
  width: 20px;
  height: 20px;
}

.stats {
  font-size: 12px;
  color: #8b98a5;
  margin-left: auto;
}

.content {
  padding: 12px;
  min-height: 80px;
}

.highlight-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.url-group {
  background: #1d2a36;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 6px;
}

.url-group:last-child {
  margin-bottom: 0;
}

.url-group-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  cursor: pointer;
  transition: background 0.15s ease;
  user-select: none;
}

.url-group-header:hover {
  background: #273340;
}

.url-group-header .url-info {
  display: flex;
  align-items: center;
  gap: 8px;
  overflow: hidden;
}

.url-group-header .url-domain {
  font-size: 12px;
  font-weight: 500;
  color: #f7f9f9;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 150px;
}

.url-group-header .url-count {
  font-size: 10px;
  background: #1d9bf0;
  color: white;
  padding: 2px 6px;
  border-radius: 10px;
  flex-shrink: 0;
}

.url-group-header .toggle-icon {
  width: 14px;
  height: 14px;
  transition: transform 0.2s ease;
  color: #8b98a5;
}

.url-group.collapsed .url-group-header .toggle-icon {
  transform: rotate(-90deg);
}

.url-group.collapsed .url-group-content {
  display: none;
}

.url-group-content {
  padding: 0 6px 6px;
  border-top: 1px solid #38444d20;
  margin-top: -1px;
}

.highlight-item {
  background: #15202b;
  border-radius: 4px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  border: 1px solid transparent;
  margin-top: 6px;
}

.highlight-item:first-child {
  margin-top: 0;
}

.highlight-item:hover {
  background: #273340;
  border-color: #1d9bf0;
}

.highlight-text {
  font-size: 12px;
  line-height: 1.4;
  margin-bottom: 6px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.highlight-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 10px;
  color: #8b98a5;
}

.highlight-color {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  border: 1px solid rgba(255,255,255,0.2);
}

.empty-state {
  text-align: center;
  padding: 24px 12px;
  color: #8b98a5;
}

.empty-state svg {
  width: 32px;
  height: 32px;
  margin-bottom: 8px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 12px;
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #38444d;
}

.btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  border: none;
}

.btn svg {
  width: 14px;
  height: 14px;
}

.btn-danger {
  background: rgba(244, 33, 46, 0.1);
  color: #f4212e;
}

.btn-danger:hover {
  background: rgba(244, 33, 46, 0.2);
}

.btn-secondary {
  background: #273340;
  color: #f7f9f9;
}

.btn-secondary:hover {
  background: #38444d;
}

.btn-profile {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  border: none;
  background: #273340;
  color: #f7f9f9;
  text-decoration: none;
}

.btn-profile:hover {
  background: #38444d;
}

.btn-profile svg {
  width: 14px;
  height: 14px;
}

.btn-primary {
  background: #1d9bf0;
  color: white;
}

.btn-primary:hover {
  background: #1a8cd8;
}

.btn-danger {
  background: rgba(244, 33, 46, 0.1);
  color: #f4212e;
}

.btn-danger:hover {
  background: rgba(244, 33, 46, 0.2);
}

.btn-profile {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  border: none;
  background: #273340;
  color: #f7f9f9;
  text-decoration: none;
}

.btn-profile:hover {
  background: #38444d;
}

.btn-profile svg {
  width: 14px;
  height: 14px;
}

.toast {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #273340;
  color: #f7f9f9;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  opacity: 0;
  transition: all 0.2s ease;
  z-index: 1000;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}
</style>
</head>
<body>
  <div class="header">
    <h1>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 11L12 14L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      Highlights
    </h1>
    <span class="stats" id="stats">0</span>
  </div>

  <div class="content">
    <div class="highlight-list" id="highlight-list"></div>

    <div class="actions">
      <button class="btn btn-danger" id="clear-all-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Clear All
      </button>
      <button class="btn btn-secondary" id="refresh-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Refresh
      </button>
      <a href="https://x.com/tanavtwt" target="_blank" class="btn btn-profile">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
        @tanavtwt
      </a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'x_highlighter_data';

    document.addEventListener('DOMContentLoaded', () => {
      loadHighlights();
      setupActions();
    });

    function setupActions() {
      document.getElementById('clear-all-btn').addEventListener('click', clearAllHighlights);
      document.getElementById('refresh-btn').addEventListener('click', loadHighlights);
    }

    function loadHighlights() {
      chrome.storage.local.get([STORAGE_KEY], (result) => {
        const highlights = result[STORAGE_KEY] || [];
        console.log('Highlights loaded:', highlights.length, 'items');
        document.getElementById('stats').textContent = highlights.length;
        renderHighlights(highlights);
      });
    }

    function getDomain(url) {
      try {
        if (!url) return 'Unknown';
        const u = new URL(url);
        return u.hostname;
      } catch {
        return 'Unknown';
      }
    }

    function renderHighlights(highlights) {
      const list = document.getElementById('highlight-list');

      if (highlights.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11L12 14L22 4"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <p>No highlights yet</p>
            <p style="font-size: 10px; margin-top: 4px; opacity: 0.7;">Select text on X.com and press Ctrl+H</p>
          </div>
        `;
        return;
      }

      const grouped = highlights.reduce((acc, h) => {
        const domain = getDomain(h.url);
        if (!acc[domain]) acc[domain] = [];
        acc[domain].push(h);
        return acc;
      }, {});

      list.innerHTML = Object.entries(grouped).map(([domain, items]) => `
        <div class="url-group" data-domain="${escapeHtml(domain)}">
          <div class="url-group-header">
            <div class="url-info">
              <span class="url-domain">${escapeHtml(domain)}</span>
              <span class="url-count">${items.length}</span>
            </div>
            <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="url-group-content">
            ${items.map(h => `
              <div class="highlight-item" data-id="${h.id}" data-url="${escapeHtml(h.url || '')}">
                <div class="highlight-text">${escapeHtml(h.text || '')}</div>
                <div class="highlight-meta">
                  <span class="highlight-color" style="background: ${h.color || '#87CEEB80'}"></span>
                  <span>${formatDate(h.timestamp)}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      list.querySelectorAll('.url-group-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('collapsed');
        });
      });

      list.querySelectorAll('.highlight-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const h = highlights.find(hl => hl.id === item.dataset.id);
          if (h) {
            navigator.clipboard.writeText(h.text).then(() => {
              showToast('Copied!');
            });
          }
        });

        item.addEventListener('dblclick', () => {
          const url = item.dataset.url;
          if (url) {
            chrome.tabs.create({ url });
          }
        });
      });
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  </script>
</body>
</html>
